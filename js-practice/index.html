<!doctype html>
<html>
 
<head>
    <title>らくらくトリセツ</title>
    <link href="app.css" rel="stylesheet">
</head>
 
<body>
    <h1>OpenCV Video</h1>
    <input type="file" id="example" multiple>
    <div> 
        <!-- 828 x 1792 -->
        <video id="video" src="../input/input1.MP4" muted width="320" height="640"></video>
    </div>
    <div hidden>ABC</div>
    <div> diff | pptxrc | src</div>
    <input type="button" value="make PPTX" onclick="makePPTX()">
    <div class="box">
        <div class="canvases">
            <canvas id="canvasOutput" width="320" height="640"></canvas>
            <canvas id="canvasOutput2" width="320" height="640"></canvas>
            <canvas id="canvasOutput3" width="320" height="640"></canvas>
        </div>
    </div>

    <script>
    </script>
    
    <!-- ここにCDNでopencv.jsとpptxgen.jsを読み込む -->
    <script async src="https://docs.opencv.org/4.6.0/opencv.js" type="text/javascript" onload="onCvLoaded();"></script>
    <script  src="https://cdn.jsdelivr.net/gh/gitbrent/pptxgenjs@3.11.0/libs/jszip.min.js"></script>
    <script  src="https://cdn.jsdelivr.net/npm/pptxgenjs@3.11.0/dist/pptxgen.min.js"></script>

    <script>
        function makeSamplePPTX() {
            // 1. Create a new Presentation
            let pptx = new PptxGenJS();
            // 2. Add a Slide
            let slide = pptx.addSlide();

            // 3. Add one or more objects (Tables, Shapes, Images, Text and Media) to the Slide
            slide.addText("Hello World from PptxGenJS...", {
                x: 1.5,
                y: 1.5,
                color: "363636",
                fill: { color: "F1F1F1" },
                align: pptx.AlignH.center,
            });

            // 4. Save the Presentation
            pptx.writeFile({ fileName: "Sample Presentation.pptx" });
        }

        function makePPTX() {
            cvs = document.getElementById('canvasOutput2');
            ctx = cvs.getContext('2d');
            imagedata = cvs.toDataURL("image/jpeg");  

            // 1. Create a new Presentation
            let pptx = new PptxGenJS();
            pptx.defineLayout({ name:'A4', width:11.7, height:8.3 });
            pptx.layout = 'A4';
            console.log("hello");
            console.log(pptx.layout);


            // 2. Add a Slide
            let slide = pptx.addSlide();

            // 3. Add one or more objects (Tables, Shapes, Images, Text and Media) to the Slide
            slide.addText("Hello World from PptxGenJS...", {
                x: 1.5,
                y: 1.5,
                color: "363636",
                fill: { color: "F1F1F1" },
                align: pptx.AlignH.center,
            });

            slide.addImage({ data: imagedata, w: 2, h: 4, x: 2, y: 1 });

            // 4. Save the Presentation
            pptx.writeFile({ fileName: "らくらくトリセツ.pptx" });
        }
    </script>

    <script>
        function onCvLoaded() {
            console.log('cv', cv);
            cv.onRuntimeInitialized = onReady;
        }
        const video = document.getElementById('video');

        
        
        const actionBtn = document.getElementById('actionBtn');
        let streaming = false;
        function onReady() {
            console.log('ready');
            let src;
            let diff_src;
            let cap;
            let frames = [];
            let index = 0;
            let pptxrc;

            video.controls = true;
            video.willReadFrequently = true;

            video.addEventListener('play', start);
            video.addEventListener('pause', stop);
            video.addEventListener('ended', stop);

            function start() {
                console.log('playing...');
                streaming = true;
                const width = video.width;
                const height = video.height;
                video.playbackRate = 1.0;
                src = new cv.Mat(height, width, cv.CV_8UC4);
                diff_src = new cv.Mat(height, width, cv.CV_8UC4);
                pptxrc = new cv.Mat(height, width, cv.CV_8UC4);
                cap = new cv.VideoCapture(video);
                setTimeout(processVideo, 0);
            }

            function stop() {
                console.log('paused or ended');
                streaming = false;
            }

            function processVideo() {
                if (!streaming) {
                    src.delete();
                    diff_src.delete();
                    return;
                }
                cap.read(src);
                
                
                index++;

                cv.absdiff(pptxrc, src, diff_src);
                cv.bitwise_not(diff_src, diff_src);
                cv.imshow('canvasOutput', diff_src);
                cv.imshow('canvasOutput2', pptxrc);
                cv.imshow('canvasOutput3', src);

                pptxrc = src.clone();
                setTimeout(processVideo, 0);
            }
        }
 
    </script>
</body>
 
</html>